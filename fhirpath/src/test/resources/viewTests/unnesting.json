{
  "title": "Unnesting tests",
  "authors": [
    "niquola"
  ],
  "generated": true,
  "resources": [
    {
      "resourceType": "Patient",
      "id": "pt1",
      "name": [
        {
          "use": "official",
          "family": "f1.1",
          "given": [
            "g1.1"
          ]
        },
        {
          "family": "f1.2",
          "given": [
            "g1.2",
            "g1.3"
          ]
        }
      ],
      "gender": "male",
      "birthDate": "1950-01-01",
      "address": [
        {
          "city": "c1"
        }
      ]
    },
    {
      "resourceType": "Patient",
      "id": "pt2",
      "name": [
        {
          "family": "f2.1",
          "given": [
            "g2.1"
          ]
        },
        {
          "use": "official",
          "family": "f2.2",
          "given": [
            "g2.2",
            "g2.3"
          ]
        }
      ],
      "gender": "female",
      "birthDate": "1950-01-01"
    }
  ],
  "tests": [
    {
      "title": "basic unnesting",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "name": "id",
                "path": "id"
              }
            ],
            "select": [
              {
                "forEach": "name",
                "column": [
                  {
                    "name": "family",
                    "path": "family"
                  },
                  {
                    "name": "given",
                    "path": "given",
                    "collection": true
                  }
                ]
              }
            ]
          }
        ]
      },
      "expect": [
        {
          "id": "pt1",
          "family": "f1.1",
          "given": [
            "g1.1"
          ]
        },
        {
          "id": "pt1",
          "family": "f1.2",
          "given": [
            "g1.2",
            "g1.3"
          ]
        },
        {
          "id": "pt2",
          "family": "f2.1",
          "given": [
            "g2.1"
          ]
        },
        {
          "id": "pt2",
          "family": "f2.2",
          "given": [
            "g2.2",
            "g2.3"
          ]
        }
      ]
    },
    {
      "title": "two levels of unnesting with $this",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "name": "id",
                "path": "id"
              }
            ],
            "select": [
              {
                "forEach": "name",
                "column": [
                  {
                    "name": "family",
                    "path": "family"
                  }
                ],
                "select": [
                  {
                    "forEach": "given",
                    "column": [
                      {
                        "name": "given",
                        "path": "$this"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      "expect": [
        {
          "id": "pt1",
          "family": "f1.1",
          "given": "g1.1"
        },
        {
          "id": "pt1",
          "family": "f1.2",
          "given": "g1.2"
        },
        {
          "id": "pt1",
          "family": "f1.2",
          "given": "g1.3"
        },
        {
          "id": "pt2",
          "family": "f2.1",
          "given": "g2.1"
        },
        {
          "id": "pt2",
          "family": "f2.2",
          "given": "g2.2"
        },
        {
          "id": "pt2",
          "family": "f2.2",
          "given": "g2.3"
        }
      ]
    },
    {
      "title": "two levels of unnesting with $this and forEachOrNull",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "name": "id",
                "path": "id"
              }
            ],
            "select": [
              {
                "forEachOrNull": "name",
                "column": [
                  {
                    "name": "family",
                    "path": "family"
                  }
                ],
                "select": [
                  {
                    "forEachOrNull": "suffix",
                    "column": [
                      {
                        "name": "suffix",
                        "path": "$this"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      "expect": [
        {
          "id": "pt1",
          "family": "f1.1",
          "suffix": null
        },
        {
          "id": "pt1",
          "family": "f1.2",
          "suffix": null
        },
        {
          "id": "pt2",
          "family": "f2.1",
          "suffix": null
        },
        {
          "id": "pt2",
          "family": "f2.2",
          "suffix": null
        }
      ]
    },
    {
      "title": "unnesting of singular element",
      "view": {
        "resource": "Patient",
        "select": [
          {
            "column": [
              {
                "name": "id",
                "path": "id"
              }
            ],
            "select": [
              {
                "forEach": "gender",
                "column": [
                  {
                    "name": "gender",
                    "path": "$this"
                  }
                ]
              }
            ]
          }
        ]
      },
      "expect": [
        {
          "id": "pt1",
          "gender": "male"
        },
        {
          "id": "pt2",
          "gender": "female"
        }
      ]
    }
  ]
}
