<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>au.csiro.pathling</groupId>
    <artifactId>pathling</artifactId>
    <version>5.0.0</version>
    <relativePath>../../pom.xml</relativePath>
  </parent>
  <artifactId>python</artifactId>
  <packaging>jar</packaging>
  <name>Pathling Python</name>
  <description>POM file for Python modules in Maven builds</description>

  <properties>
    <skip.python.tests>false</skip.python.tests>
    <pathling.pyapi.version.qualifier/>
    <pathling.pyapi.version>${project.version}${pathling.pyapi.version.qualifier}</pathling.pyapi.version>
  </properties>

  <dependencies>
    <dependency>
      <groupId>au.csiro.pathling</groupId>
      <artifactId>fhir-server</artifactId>
      <version>${project.version}</version>
      <classifier>original</classifier>
    </dependency>
  </dependencies>

  <build>
    <sourceDirectory>${project.basedir}</sourceDirectory>
    <resources>
      <resource>
        <directory>${project.basedir}</directory>
        <includes>
          <include>bunsen/**/*.py</include>
        </includes>
      </resource>
    </resources>

    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-dependency-plugin</artifactId>
        <executions>
          <execution>
            <id>copy-dependencies</id>
            <phase>generate-resources</phase>
            <goals>
              <goal>copy-dependencies</goal>
            </goals>
            <configuration>
              <classifier>all</classifier>
              <excludeTransitive>true</excludeTransitive>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>exec-maven-plugin</artifactId>
        <executions>
          <!-- Run the Python tests -->
          <execution>
            <configuration>
              <executable>py.test</executable>
              <workingDirectory>${project.basedir}</workingDirectory>
              <arguments>
                <argument>-x</argument>
                <argument>tests</argument>
              </arguments>
              <skip>${skip.python.tests}</skip>
              <environmentVariables>
                <PYTHONPATH>${project.basedir}</PYTHONPATH>
                <SHADED_JAR_PATH>
                  ${project.parent.basedir}/bunsen-spark-shaded/target/bunsen-spark-shaded-${project.version}.jar
                </SHADED_JAR_PATH>
              </environmentVariables>
            </configuration>
            <id>python-tests</id>
            <phase>test</phase>
            <goals>
              <goal>exec</goal>
            </goals>
          </execution>

          <!-- Build python distributions -->
          <execution>
            <configuration>
              <executable>python</executable>
              <workingDirectory>${project.basedir}</workingDirectory>
              <arguments>
                <argument>setup.py</argument>
                <argument>sdist</argument>
                <argument>sdist</argument>
                <argument>--dist-dir</argument>
                <argument>target/py-dist</argument>
              </arguments>
            </configuration>
            <id>python-package</id>
            <phase>package</phase>
            <goals>
              <goal>exec</goal>
            </goals>
          </execution>


          <!-- Build python documentation -->
          <execution>
            <configuration>
              <executable>sh</executable>
              <workingDirectory>${project.basedir}</workingDirectory>
              <arguments>
                <argument>-c</argument>
                <argument>sphinx-apidoc --force --full -o target/docs pathling -t docs/templates/ &amp;&amp; make -C target/docs clean html
                </argument>
              </arguments>
            </configuration>
            <id>python-docs</id>
            <phase>process-resources</phase>
            <goals>
              <goal>exec</goal>
            </goals>
          </execution>
        </executions>
      </plugin>

      <plugin>
        <groupId>ru.yaal.maven</groupId>
        <artifactId>write-text-files-maven-plugin</artifactId>
        <version>1.1</version>
        <configuration>
          <charset>UTF-8</charset>
          <files>
            <file>
              <path>pathling/_version.py</path>
              <lines>
                <line>#</line>
                <line># Auto generated from POM project version.</line>
                <line># Please do not modify.</line>
                <line>#</line>
                <line>__version__="${pathling.pyapi.version}"</line>
              </lines>
            </file>
          </files>
        </configuration>
        <executions>
          <execution>
            <id>write-text-files</id>
            <phase>generate-sources</phase>
            <goals>
              <goal>write-text-files</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>
